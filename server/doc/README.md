# STM32 HBox å›ºä»¶æœåŠ¡å™¨

## é¡¹ç›®ç®€ä»‹

STM32 HBox å›ºä»¶æœåŠ¡å™¨æ˜¯ä¸€ä¸ªä¸“ä¸ºSTM32 HBoxè®¾å¤‡è®¾è®¡çš„å›ºä»¶ç®¡ç†å’Œåˆ†å‘ç³»ç»Ÿã€‚è¯¥ç³»ç»Ÿæä¾›å›ºä»¶ä¸Šä¼ ã€ç‰ˆæœ¬ç®¡ç†ã€è®¾å¤‡æ³¨å†Œã€OTAæ›´æ–°ç­‰åŠŸèƒ½ï¼Œæ”¯æŒå¤šç§æ¸¸æˆæ‰‹æŸ„åè®®ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸ”§ **å›ºä»¶ç®¡ç†**: æ”¯æŒå›ºä»¶ä¸Šä¼ ã€ç‰ˆæœ¬æ§åˆ¶ã€æ‰¹é‡åˆ é™¤
- ğŸ“± **è®¾å¤‡æ³¨å†Œ**: è‡ªåŠ¨è®¾å¤‡IDéªŒè¯å’Œæ³¨å†Œ
- ğŸ”„ **OTAæ›´æ–°**: æ”¯æŒè®¾å¤‡åœ¨çº¿å›ºä»¶æ›´æ–°
- ğŸ® **å¤šåè®®æ”¯æŒ**: PS4ã€PS Classicã€Switchã€Xbox Oneã€XInputç­‰
- ğŸ” **å®‰å…¨è®¤è¯**: è®¾å¤‡IDå“ˆå¸ŒéªŒè¯ï¼Œç¡®ä¿å›ºä»¶å®‰å…¨æ€§
- ğŸ“Š **çŠ¶æ€ç›‘æ§**: å®æ—¶æœåŠ¡çŠ¶æ€å’Œæ—¥å¿—ç›‘æ§
- ğŸŒ **Webç•Œé¢**: ç°ä»£åŒ–çš„Webç®¡ç†ç•Œé¢

## ç³»ç»Ÿæ¶æ„

```
server/
â”œâ”€â”€ src/                    # æ ¸å¿ƒæºä»£ç 
â”‚   â”œâ”€â”€ server.js          # ä¸»æœåŠ¡å™¨æ–‡ä»¶
â”‚   â”œâ”€â”€ firmware.js        # å›ºä»¶ç®¡ç†æ¨¡å—
â”‚   â”œâ”€â”€ auth.js            # è®¤è¯æ¨¡å—
â”‚   â”œâ”€â”€ action.js          # åŠ¨ä½œå¤„ç†æ¨¡å—
â”‚   â””â”€â”€ device-auth.js     # è®¾å¤‡è®¤è¯æ¨¡å—
â”œâ”€â”€ data/                   # æ•°æ®å­˜å‚¨
â”‚   â”œâ”€â”€ firmware_list.json # å›ºä»¶åˆ—è¡¨
â”‚   â”œâ”€â”€ device_ids.json    # è®¾å¤‡IDæ•°æ®åº“
â”‚   â””â”€â”€ auth_config.json   # è®¤è¯é…ç½®
â”œâ”€â”€ tools/                  # éƒ¨ç½²å’Œç®¡ç†å·¥å…·
â”‚   â”œâ”€â”€ deploy.ps1         # ä¸»éƒ¨ç½²è„šæœ¬
â”‚   â”œâ”€â”€ deploy-simple.ps1  # ç®€åŒ–éƒ¨ç½²è„šæœ¬
â”‚   â”œâ”€â”€ service-manager.ps1 # æœåŠ¡ç®¡ç†è„šæœ¬
â”‚   â””â”€â”€ deploy-config.json # éƒ¨ç½²é…ç½®
â”œâ”€â”€ uploads/               # å›ºä»¶æ–‡ä»¶å­˜å‚¨
â”œâ”€â”€ start.js              # æœåŠ¡å¯åŠ¨è„šæœ¬
â”œâ”€â”€ stop.js               # æœåŠ¡åœæ­¢è„šæœ¬
â””â”€â”€ package.json          # é¡¹ç›®ä¾èµ–é…ç½®
```

## å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- **Node.js**: 16.x æˆ–æ›´é«˜ç‰ˆæœ¬
- **PM2**: ç”¨äºè¿›ç¨‹ç®¡ç†
- **æ“ä½œç³»ç»Ÿ**: Linux (æ¨è Ubuntu/Debian)

### æœ¬åœ°å¼€å‘

1. **å…‹éš†é¡¹ç›®**
   ```bash
   git clone <repository-url>
   cd HBox_Git/server
   ```

2. **å®‰è£…ä¾èµ–**
   ```bash
   npm install
   ```

3. **é…ç½®ç¯å¢ƒ**
   ```bash
   cp .env.example .env
   # ç¼–è¾‘ .env æ–‡ä»¶é…ç½®æ•°æ®åº“å’Œå…¶ä»–å‚æ•°
   ```

4. **å¯åŠ¨æœåŠ¡**
   ```bash
   npm start
   # æˆ–è€…ä½¿ç”¨ PM2
   pm2 start ecosystem.config.js
   ```

### ç”Ÿäº§éƒ¨ç½²

ä½¿ç”¨æä¾›çš„PowerShelléƒ¨ç½²è„šæœ¬ï¼š

```powershell
# è¿›å…¥toolsç›®å½•
cd server/tools

# ä¸€é”®éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
.\deploy-simple.ps1
```

## API æ–‡æ¡£

### å›ºä»¶ç®¡ç† API

#### è·å–å›ºä»¶åˆ—è¡¨
```http
GET /api/firmwares
```

**å“åº”ç¤ºä¾‹:**
```json
{
  "success": true,
  "data": [
    {
      "id": "firmware-001",
      "name": "HBoxå›ºä»¶ v1.0.0",
      "version": "1.0.0",
      "description": "åˆå§‹ç‰ˆæœ¬å›ºä»¶",
      "createTime": "2024-01-01T00:00:00.000Z",
      "slotA": {
        "filePath": "firmware_v1.0.0_slotA.bin",
        "size": 1024000
      },
      "slotB": {
        "filePath": "firmware_v1.0.0_slotB.bin", 
        "size": 1024000
      }
    }
  ]
}
```

#### ä¸Šä¼ å›ºä»¶
```http
POST /api/firmwares/upload
Content-Type: multipart/form-data
```

**å‚æ•°:**
- `name`: å›ºä»¶åç§°
- `version`: ç‰ˆæœ¬å·
- `description`: æè¿°ä¿¡æ¯
- `slotA`: æ§½Aå›ºä»¶æ–‡ä»¶
- `slotB`: æ§½Bå›ºä»¶æ–‡ä»¶

#### åˆ é™¤å›ºä»¶
```http
DELETE /api/firmwares/:id
```

### è®¾å¤‡ç®¡ç† API

#### è®¾å¤‡æ³¨å†Œ
```http
POST /api/devices/register
Content-Type: application/json
```

**è¯·æ±‚ä½“:**
```json
{
  "rawUniqueId": "12345678-87654321-ABCDEF01",
  "deviceId": "A1B2C3D4E5F6G7H8"
}
```

#### è·å–è®¾å¤‡åˆ—è¡¨
```http
GET /api/devices
```

### å›ºä»¶æ›´æ–° API

#### æ£€æŸ¥æ›´æ–°
```http
GET /api/firmware/check-update?deviceId=:deviceId&currentVersion=:version
```

#### ä¸‹è½½å›ºä»¶
```http
GET /api/firmware/download/:firmwareId/:slot
```

## éƒ¨ç½²é…ç½®

### ç¯å¢ƒé…ç½®

ç¼–è¾‘ `tools/deploy-config.json` æ–‡ä»¶ï¼š

```json
{
  "environments": {
    "prod": {
      "host": "182.92.72.220",
      "user": "root", 
      "path": "/opt/hbox-server",
      "ssh_key": "E:\\Works\\Ali-cloude\\182.92.72.220\\PC1125.pem",
      "port": 3000,
      "description": "ç”Ÿäº§ç¯å¢ƒ"
    }
  },
  "default_env": "prod"
}
```

### ç¯å¢ƒå˜é‡

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```env
NODE_ENV=production
PORT=3000
UPLOAD_DIR=./uploads
MAX_FILE_SIZE=50MB
JWT_SECRET=your_jwt_secret_here
LOG_LEVEL=info
```

## ç®¡ç†å·¥å…·

### éƒ¨ç½²è„šæœ¬

- **`deploy-simple.ps1`**: ä¸€é”®éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
- **`deploy.ps1`**: å®Œæ•´éƒ¨ç½²è„šæœ¬ï¼Œæ”¯æŒå¤šç¯å¢ƒ
- **`service-manager.ps1`**: æœåŠ¡ç®¡ç†å·¥å…·

### æœåŠ¡ç®¡ç†

```powershell
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
.\service-manager.ps1 status

# é‡å¯æœåŠ¡
.\service-manager.ps1 restart

# æŸ¥çœ‹æ—¥å¿—
.\service-manager.ps1 logs

# å¥åº·æ£€æŸ¥
.\service-manager.ps1 health
```

### è¿æ¥æµ‹è¯•

```powershell
# æµ‹è¯•æœåŠ¡å™¨è¿æ¥
.\test-connection.ps1
```

## ç›‘æ§å’Œæ—¥å¿—

### PM2 ç®¡ç†

```bash
# æŸ¥çœ‹è¿›ç¨‹çŠ¶æ€
pm2 list

# æŸ¥çœ‹æ—¥å¿—
pm2 logs hbox-firmware-server

# é‡å¯æœåŠ¡
pm2 restart hbox-firmware-server

# åœæ­¢æœåŠ¡
pm2 stop hbox-firmware-server
```

### æ—¥å¿—æ–‡ä»¶

- `logs/out.log`: æ ‡å‡†è¾“å‡ºæ—¥å¿—
- `logs/err.log`: é”™è¯¯æ—¥å¿—
- `logs/combined.log`: åˆå¹¶æ—¥å¿—

## å®‰å…¨è€ƒè™‘

### è®¾å¤‡IDéªŒè¯

ç³»ç»Ÿä½¿ç”¨SHA256å“ˆå¸Œç®—æ³•éªŒè¯è®¾å¤‡IDï¼š

```javascript
// è®¾å¤‡IDå“ˆå¸Œç®—æ³•
const salt1 = 0x48426F78;  // "HBox"
const salt2 = 0x32303234;  // "2024"
// ... è¯¦ç»†ç®—æ³•è§ firmware.js
```

### æ–‡ä»¶ä¸Šä¼ å®‰å…¨

- æ–‡ä»¶ç±»å‹éªŒè¯
- æ–‡ä»¶å¤§å°é™åˆ¶
- ç—…æ¯’æ‰«æï¼ˆå¯é€‰ï¼‰

### è®¿é—®æ§åˆ¶

- JWTä»¤ç‰Œè®¤è¯
- è¯·æ±‚é¢‘ç‡é™åˆ¶
- CORSé…ç½®

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **éƒ¨ç½²å¤±è´¥**
   - æ£€æŸ¥SSHå¯†é’¥æƒé™
   - ç¡®è®¤æœåŠ¡å™¨ç½‘ç»œè¿æ¥
   - éªŒè¯Node.jsç‰ˆæœ¬

2. **æœåŠ¡æ— æ³•å¯åŠ¨**
   - æ£€æŸ¥ç«¯å£å ç”¨
   - éªŒè¯é…ç½®æ–‡ä»¶
   - æŸ¥çœ‹é”™è¯¯æ—¥å¿—

3. **å›ºä»¶ä¸Šä¼ å¤±è´¥**
   - æ£€æŸ¥æ–‡ä»¶å¤§å°é™åˆ¶
   - éªŒè¯æ–‡ä»¶æ ¼å¼
   - ç¡®è®¤å­˜å‚¨æƒé™

### è°ƒè¯•æ¨¡å¼

```bash
# å¯ç”¨è°ƒè¯•æ—¥å¿—
export DEBUG=*
npm start
```

## å¼€å‘æŒ‡å—

### ä»£ç ç»“æ„

- **æ¨¡å—åŒ–è®¾è®¡**: æ¯ä¸ªåŠŸèƒ½æ¨¡å—ç‹¬ç«‹
- **é”™è¯¯å¤„ç†**: ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶
- **æ—¥å¿—è®°å½•**: ç»“æ„åŒ–æ—¥å¿—è¾“å‡º
- **é…ç½®ç®¡ç†**: ç¯å¢ƒå˜é‡é…ç½®

### æ·»åŠ æ–°åŠŸèƒ½

1. åœ¨ `src/` ç›®å½•åˆ›å»ºæ–°æ¨¡å—
2. åœ¨ `server.js` ä¸­æ³¨å†Œè·¯ç”±
3. æ›´æ–°APIæ–‡æ¡£
4. æ·»åŠ å•å…ƒæµ‹è¯•

### æµ‹è¯•

```bash
# è¿è¡Œæµ‹è¯•
npm test

# ä»£ç æ£€æŸ¥
npm run lint
```

## ç‰ˆæœ¬å†å²

### v1.0.0 (2024-01-01)
- åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
- åŸºç¡€å›ºä»¶ç®¡ç†åŠŸèƒ½
- è®¾å¤‡æ³¨å†Œå’Œè®¤è¯
- Webç®¡ç†ç•Œé¢

## è´¡çŒ®æŒ‡å—

1. Fork é¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
3. æäº¤æ›´æ”¹
4. å‘èµ· Pull Request

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶

## è”ç³»æ–¹å¼

- é¡¹ç›®ç»´æŠ¤è€…: [ç»´æŠ¤è€…å§“å]
- é‚®ç®±: [é‚®ç®±åœ°å€]
- é¡¹ç›®åœ°å€: [GitHubåœ°å€]

---

**æ³¨æ„**: è¿™æ˜¯ä¸€ä¸ªç”Ÿäº§ç¯å¢ƒçš„å›ºä»¶æœåŠ¡å™¨ï¼Œè¯·ç¡®ä¿åœ¨ç”Ÿäº§éƒ¨ç½²å‰è¿›è¡Œå……åˆ†çš„æµ‹è¯•ã€‚
